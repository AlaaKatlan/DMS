<div class="settings-card users-card" dir="rtl">
  <div class="card-header">
    <div class="header-right">
      <div class="icon-box info">
        <lucide-angular name="users" [size]="24"></lucide-angular>
      </div>
      <div class="titles">
        <h2>إدارة المستخدمين</h2>
        <p>التحكم الكامل ببيانات الموظفين وصلاحياتهم</p>
      </div>
    </div>

    <div class="actions-head">
      <button class="btn-add" (click)="openAddModal()">
        <lucide-angular name="user-plus" [size]="18"></lucide-angular>
        <span>دعوة مستخدم</span>
      </button>

      <button class="btn-refresh" (click)="loadUsers()">
        <lucide-angular name="rotate-cw" [size]="18"></lucide-angular>
      </button>
    </div>
  </div>

  <div class="table-container">
    @if (loading) {
      <div class="loading-state">جاري تحميل البيانات...</div>
    } @else {
      <table class="users-table">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>البريد الإلكتروني</th>
            <th>الهاتف</th>
            <th>الصلاحية</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user.id) {
            <tr>
              <td>
                <div class="user-info">
                  <div class="avatar-circle">{{ user.full_name.charAt(0) || '?' }}</div>
                  <span class="user-name">{{ user.full_name }}</span>
                </div>
              </td>
              <td class="email-col">{{ user.email }}</td>
              <td>{{ user.phone || '-' }}</td>
              <td>
                <span class="role-badge" [class]="user.role">
                  {{ getRoleLabel(user.role) }}
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn-icon edit" (click)="openEditModal(user)" title="تعديل البيانات">
                    <lucide-angular name="edit-3" [size]="18"></lucide-angular>
                  </button>
                  <button class="btn-icon delete" (click)="deleteUser(user)" title="حذف المستخدم">
                    <lucide-angular name="trash-2" [size]="18"></lucide-angular>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>
</div>

@if (showModal) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditMode ? 'تعديل بيانات المستخدم' : 'دعوة مستخدم جديد' }}</h3>
        <button class="btn-close" (click)="closeModal()"><lucide-angular name="x"></lucide-angular></button>
      </div>

      <div class="modal-body">
        @if (!isEditMode) {
          <div class="alert-info">
            <lucide-angular name="info" [size]="16"></lucide-angular>
            <p>لإضافة مستخدم جديد، يفضل استخدام لوحة تحكم Supabase لإرسال دعوة بريدية، أو إنشاء حساب له يدوياً.</p>
          </div>
        }

        <div class="form-group">
          <label>الاسم الكامل</label>
          <input type="text" [(ngModel)]="currentUserForm.full_name" placeholder="الاسم">
        </div>

        <div class="form-group">
          <label>الصلاحية (Role)</label>
          <select [(ngModel)]="currentUserForm.role">
            @for (role of roles; track role.value) {
              <option [value]="role.value">{{ role.label }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label>رقم الهاتف</label>
          <input type="text" [(ngModel)]="currentUserForm.phone" placeholder="09...">
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModal()">إلغاء</button>
        <button class="btn-save" (click)="saveUser()">{{ isEditMode ? 'حفظ التعديلات' : 'تم' }}</button>
      </div>
    </div>
  </div>
}
